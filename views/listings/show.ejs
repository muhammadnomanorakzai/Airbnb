<% layout("/layout/boilerplate") -%>
<body class="bg-light">
  <div class="container my-5">
    <!-- Listing Card -->
    <div
      class="card shadow border-0 rounded-4 mx-auto"
      style="max-width: 650px">
      <img
        src="<%= listings.image.url %>"
        alt="<%= listings.title %>"
        class="card-img-top rounded-top-4"
        style="height: 300px; object-fit: cover" />
      <div class="card-body p-4">
        <p class="card-text">Owned By: <i><%= listings.owner.username %></i></p>
        <h2 class="card-title text-success fw-bold mb-3">
          <%= listings.title %>
        </h2>

        <p class="text-muted mb-2">
          <i class="bi bi-geo-alt-fill text-danger"></i>
          <%= listings.location %>, <%= listings.country %>
        </p>

        <p class="mb-3"><%= listings.description %></p>

        <h4 class="text-success fw-semibold mb-4">
          Rs <%= listings.price %> / night
        </h4>
        <% if(currUser && listings.owner._id.equals(currUser._id)) { %>
        <div class="d-flex justify-content-between align-items-center">
          <a
            href="/listings/<%= listings._id %>/edit"
            class="btn btn-outline-primary px-4">
            <i class="bi bi-pencil-square"></i> Edit
          </a>

          <form
            method="POST"
            action="/listings/<%= listings._id %>?_method=DELETE"
            onsubmit="return confirm('Are you sure you want to delete this listing?');">
            <button class="btn btn-outline-danger px-4">
              <i class="bi bi-trash"></i> Delete
            </button>
          </form>
        </div>
        <% } %>
      </div>
    </div>

    <!-- Review Form (Simple & Professional) -->
    <div class="mt-5 mx-auto" style="max-width: 650px">
      <% if(currUser) { %>
      <h3 class="fw-bold mb-3 text-primary">Write a Review</h3>

      <form
        method="POST"
        action="/listings/<%= listings._id %>/reviews"
        class="p-4 bg-white shadow-sm rounded-4 border needs-validation"
        novalidate>
        <!-- Rating -->
        <div class="mb-3">
          <label for="rating" class="form-label w-100">Rating</label>
          <input
            type="range"
            id="rating"
            min="1"
            max="5"
            step="1"
            name="review[rating]"
            class="form-range rating-slider" />
        </div>

        <!-- Comment -->
        <div class="mb-3">
          <label class="form-label fw-semibold mb-2">Comment</label>
          <textarea
            name="review[comment]"
            rows="4"
            class="form-control mb-4"
            placeholder="Write your review here..."
            required></textarea>
          <div class="invalid-feedback">
            please Submit some comments for review
          </div>
        </div>
        <div class="mb-3">
          <!-- Submit -->
          <button class="btn btn-success px-4 py-2">Submit Review</button>
        </div>
      </form>
      <% } %>
      <hr />
      <h4 class="mb-4">All Reviews</h4>

      <div class="row g-3">
        <% for (let review of listings.reviews) { %>
        <div class="col-md-6">
          <div class="card p-3 shadow-sm rounded-4 border">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="card-title"><%= review.author.username %></p>
              <span class="fw-semibold">Rating:</span>
              <span class="text-warning">
                <% for (let i = 0; i < review.rating; i++) { %> ★ <% } %> <% for
                (let i = review.rating; i < 5; i++) { %> ☆ <% } %>
              </span>
            </div>
            <p class="mb-2"><%= review.comment %></p>
            <small class="text-muted">
              Reviewed on <%= new Date(review.createdAt).toLocaleDateString() %>
            </small>
            <form
              method="POST"
              action="/listings/<%= listings._id %>/reviews/<%=review._id %>?_method=DELETE">
              <button class="btn btn-sm btn-success">Delete</button>
            </form>
          </div>
        </div>
        <% } %>
      </div>
    </div>
  </div>

  <style>
    .btn {
      transition: all 0.3s ease;
    }
    .btn:hover {
      transform: scale(1.05);
    }
    .card:hover {
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      transform: translateY(-3px);
      transition: all 0.3s ease;
    }
    .rating-slider {
      width: 100%; /* Full width */
      accent-color: #198754; /* Bootstrap success color (green) */
    }
  </style>
</body>
